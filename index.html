<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Code Generator & Scanner</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #667eea;
      --secondary: #764ba2;
      --success: #4CAF50;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --dark: #343a40;
      --light: #f8f9fa;
      --whatsapp: #25D366;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .app-container {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 30px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .main-content {
      padding: 30px;
    }

    .sidebar {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 30px;
      border-left: 1px solid #dee2e6;
    }

    .input-section {
      margin-bottom: 30px;
    }

    .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    input[type="text"], input[type="url"], input[type="tel"], input[type="email"], select {
      flex: 1;
      padding: 15px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      outline: none;
      transition: all 0.3s ease;
    }

    input:focus, select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      padding: 15px 25px;
      font-size: 16px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #45a049 100%);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%);
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--warning) 0%, #e0a800 100%);
      color: var(--dark);
    }

    .btn-whatsapp {
      background: linear-gradient(135deg, var(--whatsapp) 0%, #128C7E 100%);
    }

    .btn-info {
      background: linear-gradient(135deg, var(--info) 0%, #138496 100%);
    }

    .qr-display-section {
      text-align: center;
      margin: 30px 0;
    }

    .qr-container {
      position: relative;
      display: inline-block;
      margin: 20px 0;
    }

    #qrcode {
      border: 20px solid var(--primary);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      background: white;
      padding: 15px;
      transition: all 0.3s ease;
    }

    .qr-logo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      background: white;
      border-radius: 12px;
      padding: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .logo-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }

    .logo-placeholder {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      font-weight: bold;
    }

    .hidden {
      display: none !important;
    }

    .section {
      background: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }

    .section h3 {
      margin-bottom: 20px;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section h3 i {
      color: var(--primary);
    }

    .option-group {
      margin: 20px 0;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }

    input[type="color"], input[type="range"], input[type="file"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }

    .file-upload {
      background: #f8f9fa;
      border: 2px dashed #dee2e6;
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 15px;
    }

    .file-upload:hover {
      border-color: var(--primary);
      background: #f0f2ff;
    }

    .logo-preview {
      margin-top: 15px;
      text-align: center;
    }

    .logo-preview img {
      max-width: 120px;
      max-height: 120px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .logo-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 15px;
    }

    .logo-size-control {
      flex: 2;
    }

    .color-palette {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .color-option {
      width: 100%;
      height: 40px;
      border-radius: 8px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .color-option:hover {
      transform: scale(1.05);
    }

    .color-option.active {
      border-color: var(--dark);
    }

    .template-gallery {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 15px;
    }

    .template-item {
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .template-item:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .template-item.active {
      border-color: var(--primary);
      background: #f0f2ff;
    }

    .template-preview {
      width: 80px;
      height: 80px;
      margin: 0 auto 10px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }

    .stat-item {
      background: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .stat-number {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
    }

    .history-item {
      display: flex;
      justify-content: between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .history-item:hover {
      background: #f8f9fa;
    }

    .history-qr {
      width: 40px;
      height: 40px;
      margin-right: 15px;
    }

    .history-info {
      flex: 1;
    }

    .history-url {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-date {
      font-size: 0.8rem;
      color: #666;
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }

    .feature-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .feature-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .feature-icon {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 10px;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .tab-container {
      margin-top: 20px;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .tab.active {
      border-bottom-color: var(--primary);
      color: var(--primary);
      font-weight: 500;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .whatsapp-preview {
      background: var(--whatsapp);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      text-align: center;
    }

    .whatsapp-preview i {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    /* Scanner Styles */
    .scanner-container {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
    }

    #scanner-video {
      width: 100%;
      border-radius: 15px;
      background: #000;
    }

    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 2px solid var(--primary);
      border-radius: 15px;
      pointer-events: none;
    }

    .scan-line {
      position: absolute;
      top: 20%;
      left: 10%;
      width: 80%;
      height: 2px;
      background: var(--primary);
      animation: scan 2s linear infinite;
    }

    @keyframes scan {
      0% { top: 20%; }
      50% { top: 80%; }
      100% { top: 20%; }
    }

    .scan-result {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      text-align: left;
    }

    .scan-result h4 {
      margin-bottom: 10px;
      color: var(--primary);
    }

    .scan-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .scan-actions .btn {
      flex: 1;
    }

    .camera-select {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .app-container {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        border-left: none;
        border-top: 1px solid #dee2e6;
      }
      
      .input-group {
        flex-direction: column;
      }
      
      .feature-grid {
        grid-template-columns: 1fr;
      }

      .scan-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-qrcode"></i> QR Code Generator & Scanner</h1>
      <p>Buat dan Scan QR Code dengan mudah</p>
      <br>
      <p style="font-size: 12px;">By Ahmadz</p>
    </div>

    <div class="app-container">
      <div class="main-content">
        <div class="section">
          <div class="input-group">
            <input type="url" id="link" placeholder="Masukkan URL, teks, atau data lainnya..." />
            <button class="btn" onclick="buatQR()"><i class="fas fa-bolt"></i> Generate QR</button>
          </div>
          
          <div class="input-group">
            <select id="qrType" onchange="ubahTipeQR()">
              <option value="url">URL Website</option>
              <option value="text">Teks Biasa</option>
              <option value="email">Email</option>
              <option value="phone">Nomor Telepon</option>
              <option value="sms">SMS</option>
              <option value="wifi">Wi-Fi</option>
              <option value="whatsapp">Kontak WA</option>
            </select>
          </div>

          <div id="dynamicFields"></div>
        </div>

        <div class="qr-display-section">
          <div class="qr-container">
            <div id="qrcode"></div>
            <div class="qr-logo hidden" id="logoContainer">
              <div class="logo-placeholder" id="logoPlaceholder"><i class="fas fa-image"></i></div>
              <img id="logoImage" class="logo-image hidden" src="" alt="Logo">
            </div>
          </div>
          
          <div class="stats">
            <div class="stat-item">
              <div class="stat-number" id="qrSize">0x0</div>
              <div class="stat-label">Ukuran QR</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="qrTypeLabel">URL</div>
              <div class="stat-label">Tipe QR</div>
            </div>
          </div>

          <div style="margin-top: 20px;">
            <button class="btn btn-success" onclick="downloadQR()" id="downloadBtn" style="display: none;">
              <i class="fas fa-download"></i> Download QR Code
            </button>
            <button class="btn" onclick="shareQR()" id="shareBtn" style="display: none;">
              <i class="fas fa-share-alt"></i> Share
            </button>
            <button class="btn btn-warning" onclick="simpanKeHistory()" id="saveBtn" style="display: none;">
              <i class="fas fa-save"></i> Simpan
            </button>
          </div>
        </div>

        <div class="section">
          <h3><i class="fas fa-palette"></i> Template Cepat</h3>
          <div class="template-gallery">
            <div class="template-item" onclick="applyTemplate('social')">
              <div class="template-preview" style="background: linear-gradient(135deg, #3b5998, #8b9dc3);">
                <i class="fab fa-facebook-f" style="color: white;"></i>
              </div>
              <div>Social Media</div>
            </div>
            <div class="template-item" onclick="applyTemplate('business')">
              <div class="template-preview" style="background: linear-gradient(135deg, #ff6b6b, #ffa8a8);">
                <i class="fas fa-briefcase" style="color: white;"></i>
              </div>
              <div>Bisnis</div>
            </div>
            <div class="template-item" onclick="applyTemplate('whatsapp')">
              <div class="template-preview" style="background: linear-gradient(135deg, #25D366, #128C7E);">
                <i class="fab fa-whatsapp" style="color: white;"></i>
              </div>
              <div>WhatsApp</div>
            </div>
            <div class="template-item" onclick="applyTemplate('creative')">
              <div class="template-preview" style="background: linear-gradient(135deg, #ffd93d, #fffa8a);">
                <i class="fas fa-paint-brush" style="color: #333;"></i>
              </div>
              <div>Kreatif</div>
            </div>
          </div>
        </div>
      </div>

      <div class="sidebar">
        <div class="tabs">
          <div class="tab active" onclick="bukaTab('customize')">Kustomisasi</div>
          <div class="tab" onclick="bukaTab('history')">Riwayat</div>
          <div class="tab" onclick="bukaTab('scanner')">Scanner</div>
        </div>

        <div class="tab-container">
          <div id="customize" class="tab-content active">
            <div class="section">
              <h3><i class="fas fa-image"></i> Logo & Gambar</h3>
              <div class="file-upload" onclick="document.getElementById('logoUpload').click()">
                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <div>Klik untuk Upload Logo</div>
                <div style="font-size: 12px; color: #666;">PNG, JPG, GIF (Maks. 5MB)</div>
              </div>
              <input type="file" id="logoUpload" accept="image/*" class="hidden" onchange="handleLogoUpload(event)">
              
              <div class="logo-preview hidden" id="logoPreview">
                <img id="previewImage" src="" alt="Logo Preview">
                <div style="margin-top: 10px; font-size: 14px; color: #666;">Preview Logo</div>
              </div>

              <div class="logo-controls hidden" id="logoControls">
                <div class="option-group">
                  <label>Ukuran Logo: <span id="logoSizeValue">60</span>px</label>
                  <input type="range" id="logoSize" min="30" max="100" value="60" oninput="ubahUkuranLogo()">
                </div>
                <button class="btn btn-danger" onclick="hapusLogo()" style="width: 100%;">
                  <i class="fas fa-trash"></i> Hapus Logo
                </button>
              </div>
            </div>

            <div class="section">
              <h3><i class="fas fa-paint-brush"></i> Warna & Desain</h3>
              
              <div class="option-group">
                <label>Warna QR Code</label>
                <input type="color" id="qrColor" value="#000000" onchange="ubahWarnaQR()">
              </div>

              <div class="option-group">
                <label>Warna Background</label>
                <input type="color" id="bgColor" value="#ffffff" onchange="ubahWarnaQR()">
              </div>

              <div class="option-group">
                <label>Palet Warna Cepat</label>
                <div class="color-palette">
                  <div class="color-option active" style="background: #000000;" onclick="pilihWarnaCepat('#000000', '#ffffff')"></div>
                  <div class="color-option" style="background: #667eea;" onclick="pilihWarnaCepat('#667eea', '#ffffff')"></div>
                  <div class="color-option" style="background: #25D366;" onclick="pilihWarnaCepat('#25D366', '#ffffff')"></div>
                  <div class="color-option" style="background: #ff6b6b;" onclick="pilihWarnaCepat('#ff6b6b', '#ffffff')"></div>
                  <div class="color-option" style="background: #ffd93d;" onclick="pilihWarnaCepat('#ffd93d', '#000000')"></div>
                  <div class="color-option" style="background: #6c5ce7;" onclick="pilihWarnaCepat('#6c5ce7', '#ffffff')"></div>
                </div>
              </div>
            </div>

            <div class="section">
              <h3><i class="fas fa-crop-alt"></i> Ukuran & Border</h3>
              
              <div class="option-group">
                <label>Ukuran QR: <span id="qrSizeValue">250</span>px</label>
                <input type="range" id="qrSizeSlider" min="150" max="400" value="250" oninput="ubahUkuranQR()">
              </div>

              <div class="option-group">
                <label>Style Border</label>
                <select id="borderStyle" onchange="ubahBorder()">
                  <option value="solid">Solid</option>
                  <option value="dashed">Dashed</option>
                  <option value="dotted">Dotted</option>
                  <option value="double">Double</option>
                  <option value="none">Tidak Ada</option>
                </select>
              </div>

              <div class="option-group">
                <label>Warna Border</label>
                <input type="color" id="borderColor" value="#667eea" onchange="ubahBorder()">
              </div>
            </div>
          </div>

          <div id="history" class="tab-content">
            <div class="section">
              <h3><i class="fas fa-history"></i> Riwayat QR Code</h3>
              <div id="historyList">
                <div style="text-align: center; padding: 20px; color: #666;">
                  <i class="fas fa-history" style="font-size: 3rem; margin-bottom: 10px;"></i>
                  <div>Belum ada riwayat</div>
                </div>
              </div>
              <button class="btn btn-danger" onclick="clearHistory()" style="width: 100%; margin-top: 15px;">
                <i class="fas fa-trash"></i> Hapus Semua Riwayat
              </button>
            </div>
          </div>

          <div id="scanner" class="tab-content">
            <div class="section">
              <h3><i class="fas fa-camera"></i> QR Code Scanner</h3>
              
              <div class="option-group">
                <label>Pilih Kamera:</label>
                <select id="cameraSelect" class="camera-select" onchange="gantiKamera()">
                  <option value="">Memuat kamera...</option>
                </select>
              </div>

              <div class="scanner-container">
                <video id="scanner-video" muted playsinline></video>
                <div class="scanner-overlay">
                  <div class="scan-line"></div>
                </div>
              </div>

              <div class="scan-result hidden" id="scanResult">
                <h4><i class="fas fa-check-circle"></i> QR Code Terdeteksi!</h4>
                <div id="scanResultContent"></div>
                <div class="scan-actions">
                  <button class="btn btn-success" onclick="gunakanHasilScan()">
                    <i class="fas fa-check"></i> Gunakan
                  </button>
                  <button class="btn" onclick="salinHasilScan()">
                    <i class="fas fa-copy"></i> Salin
                  </button>
                  <button class="btn btn-danger" onclick="resetScanner()">
                    <i class="fas fa-redo"></i> Scan Lagi
                  </button>
                </div>
              </div>

              <div class="scan-actions" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="mulaiScan()" id="startScanBtn">
                  <i class="fas fa-play"></i> Mulai Scan
                </button>
                <button class="btn btn-danger" onclick="berhentiScan()" id="stopScanBtn" style="display: none;">
                  <i class="fas fa-stop"></i> Berhenti
                </button>
              </div>

              <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <h4><i class="fas fa-lightbulb"></i> Tips Scanning:</h4>
                <ul style="text-align: left; margin-top: 10px; padding-left: 20px;">
                  <li>Pastikan QR code dalam frame kamera</li>
                  <li>Jaga jarak optimal 15-30 cm</li>
                  <li>Pastikan pencahayaan cukup</li>
                  <li>Hindari silau dan bayangan</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State management
    let currentQRCode = null;
    let currentLogo = null;
    let logoSize = 60;
    let qrHistory = JSON.parse(localStorage.getItem('qrHistory')) || [];
    
    // Scanner variables
    let scannerStream = null;
    let scannerActive = false;
    let scanInterval = null;

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      loadHistory();
      updateStats();
      setupEventListeners();
      ubahTipeQR();
      loadCameras();
    });

    function setupEventListeners() {
      document.getElementById('link').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') buatQR();
      });
      setupDragAndDrop();
    }

    // QR Code Generation Functions
    function buatQR() {
      const container = document.getElementById('qrcode');
      const qrType = document.getElementById('qrType').value;
      
      let qrContent = '';
      
      if (qrType === 'whatsapp') {
        const phone = document.getElementById('whatsappPhone').value.trim();
        const message = document.getElementById('whatsappMessage').value.trim();
        
        if (!phone) {
          showNotification('Silakan masukkan nomor WhatsApp!', 'warning');
          return;
        }
        
        const formattedPhone = phone.replace(/\D/g, '');
        qrContent = `https://wa.me/${formattedPhone}`;
        
        if (message) {
          qrContent += `?text=${encodeURIComponent(message)}`;
        }
      } else {
        const linkInput = document.getElementById('link');
        qrContent = linkInput.value.trim();
        
        if (!qrContent) {
          showNotification('Silakan masukkan konten untuk QR code!', 'warning');
          return;
        }

        qrContent = formatQRContent(qrContent, qrType);
        if (!qrContent) return;
      }

      container.innerHTML = '';

      const qrColor = document.getElementById('qrColor').value;
      const bgColor = document.getElementById('bgColor').value;
      const qrSize = parseInt(document.getElementById('qrSizeSlider').value);

      currentQRCode = new QRCode(container, {
        text: qrContent,
        width: qrSize,
        height: qrSize,
        colorDark: qrColor,
        colorLight: bgColor,
        correctLevel: QRCode.CorrectLevel.H
      });

      setTimeout(() => {
        document.getElementById('downloadBtn').style.display = 'inline-block';
        document.getElementById('shareBtn').style.display = 'inline-block';
        document.getElementById('saveBtn').style.display = 'inline-block';
        updateLogoPosition();
        updateStats();
        showNotification('QR code berhasil dibuat!', 'success');
        
        if (qrType === 'whatsapp') {
          showWhatsAppPreview();
        }
      }, 300);
    }

    function formatQRContent(content, type) {
      switch(type) {
        case 'url':
          if (!content.startsWith('http')) {
            content = 'https://' + content;
          }
          return content;
        case 'email':
          return `mailto:${content}`;
        case 'phone':
          return `tel:${content}`;
        case 'sms':
          return `sms:${content}`;
        case 'wifi':
          const password = document.getElementById('wifiPassword')?.value || 'password';
          const encryption = document.getElementById('wifiEncryption')?.value || 'WPA';
          return `WIFI:S:${content};T:${encryption};P:${password};;`;
        default:
          return content;
      }
    }

    // Scanner Functions
    async function loadCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        const cameraSelect = document.getElementById('cameraSelect');
        
        cameraSelect.innerHTML = '<option value="">Pilih Kamera...</option>';
        videoDevices.forEach((device, index) => {
          const label = device.label || `Kamera ${index + 1}`;
          cameraSelect.innerHTML += `<option value="${device.deviceId}">${label}</option>`;
        });
      } catch (error) {
        console.error('Error loading cameras:', error);
        showNotification('Tidak dapat mengakses kamera', 'error');
      }
    }

    async function mulaiScan() {
      const cameraSelect = document.getElementById('cameraSelect');
      const selectedCameraId = cameraSelect.value;
      
      if (!selectedCameraId) {
        showNotification('Pilih kamera terlebih dahulu!', 'warning');
        return;
      }

      try {
        const constraints = {
          video: {
            deviceId: selectedCameraId ? { exact: selectedCameraId } : undefined,
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        };

        scannerStream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = document.getElementById('scanner-video');
        video.srcObject = scannerStream;
        
        await video.play();
        
        document.getElementById('startScanBtn').style.display = 'none';
        document.getElementById('stopScanBtn').style.display = 'inline-block';
        scannerActive = true;
        
        // Start scanning loop
        scanInterval = setInterval(scanQRCode, 100);
        showNotification('Scanner aktif! Arahkan kamera ke QR code', 'success');
        
      } catch (error) {
        console.error('Error starting scanner:', error);
        showNotification('Tidak dapat mengakses kamera: ' + error.message, 'error');
      }
    }

    function berhentiScan() {
      scannerActive = false;
      
      if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
      }
      
      if (scannerStream) {
        scannerStream.getTracks().forEach(track => track.stop());
        scannerStream = null;
      }
      
      const video = document.getElementById('scanner-video');
      video.srcObject = null;
      
      document.getElementById('startScanBtn').style.display = 'inline-block';
      document.getElementById('stopScanBtn').style.display = 'none';
      document.getElementById('scanResult').classList.add('hidden');
      
      showNotification('Scanner dihentikan', 'info');
    }

    function scanQRCode() {
      if (!scannerActive) return;
      
      const video = document.getElementById('scanner-video');
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      
      if (code) {
        handleScanResult(code.data);
      }
    }

    function handleScanResult(result) {
      document.getElementById('scanResultContent').textContent = result;
      document.getElementById('scanResult').classList.remove('hidden');
      
      // Stop scanning after successful detection
      berhentiScan();
      
      showNotification('QR code berhasil dipindai!', 'success');
    }

    function gunakanHasilScan() {
      const result = document.getElementById('scanResultContent').textContent;
      document.getElementById('link').value = result;
      
      // Try to detect content type
      if (result.startsWith('http')) {
        document.getElementById('qrType').value = 'url';
      } else if (result.startsWith('mailto:')) {
        document.getElementById('qrType').value = 'email';
        document.getElementById('link').value = result.replace('mailto:', '');
      } else if (result.startsWith('tel:')) {
        document.getElementById('qrType').value = 'phone';
        document.getElementById('link').value = result.replace('tel:', '');
      } else if (result.startsWith('sms:')) {
        document.getElementById('qrType').value = 'sms';
        document.getElementById('link').value = result.replace('sms:', '');
      } else if (result.startsWith('WIFI:')) {
        document.getElementById('qrType').value = 'wifi';
        // Parse WiFi data
        const wifiData = parseWifiString(result);
        document.getElementById('link').value = wifiData.ssid || '';
      } else {
        document.getElementById('qrType').value = 'text';
      }
      
      ubahTipeQR();
      bukaTab('customize');
      showNotification('Hasil scan diterapkan!', 'success');
    }

    function parseWifiString(wifiString) {
      const data = {};
      const pairs = wifiString.split(';');
      pairs.forEach(pair => {
        const [key, value] = pair.split(':');
        if (key && value) {
          data[key] = value;
        }
      });
      return data;
    }

    function salinHasilScan() {
      const result = document.getElementById('scanResultContent').textContent;
      navigator.clipboard.writeText(result).then(() => {
        showNotification('Teks berhasil disalin!', 'success');
      });
    }

    function resetScanner() {
      document.getElementById('scanResult').classList.add('hidden');
      mulaiScan();
    }

    function gantiKamera() {
      if (scannerActive) {
        berhentiScan();
        setTimeout(mulaiScan, 500);
      }
    }

    function bukaScanner() {
      bukaTab('scanner');
      loadCameras();
    }

    // Other existing functions (ubahTipeQR, handleLogoUpload, etc.)
    function ubahTipeQR() {
      const qrType = document.getElementById('qrType').value;
      const dynamicFields = document.getElementById('dynamicFields');
      const linkInput = document.getElementById('link');
      
      let placeholder = '';
      
      switch(qrType) {
        case 'url':
          placeholder = 'Masukkan URL website...';
          dynamicFields.innerHTML = '';
          break;
        case 'text':
          placeholder = 'Masukkan teks...';
          dynamicFields.innerHTML = '';
          break;
        case 'email':
          placeholder = 'Masukkan alamat email...';
          dynamicFields.innerHTML = '';
          break;
        case 'phone':
          placeholder = 'Masukkan nomor telepon...';
          dynamicFields.innerHTML = '';
          break;
        case 'sms':
          placeholder = 'Masukkan nomor telepon...';
          dynamicFields.innerHTML = '';
          break;
        case 'wifi':
          placeholder = 'Masukkan nama WiFi...';
          dynamicFields.innerHTML = `
            <div class="input-group">
              <input type="text" id="wifiPassword" placeholder="Password WiFi" />
              <select id="wifiEncryption">
                <option value="WPA">WPA/WPA2</option>
                <option value="WEP">WEP</option>
                <option value="nopass">Tidak Ada Password</option>
              </select>
            </div>
          `;
          break;
        case 'whatsapp':
          placeholder = 'Kontak WhatsApp';
          dynamicFields.innerHTML = `
            <div class="input-group">
              <input type="tel" id="whatsappPhone" placeholder="Nomor WhatsApp (contoh: 628123456789)" />
            </div>
            <div class="input-group">
              <input type="text" id="whatsappMessage" placeholder="Pesan default (opsional)" />
            </div>
            <div class="whatsapp-preview">
              <i class="fab fa-whatsapp"></i>
              <div>QR code akan membuka chat WhatsApp</div>
            </div>
          `;
          break;
      }
      
      if (qrType !== 'whatsapp') {
        linkInput.placeholder = placeholder;
      }
    }

    // ... (Other functions remain the same as previous implementation)
    function showWhatsAppPreview() {
      const phone = document.getElementById('whatsappPhone').value.trim();
      const message = document.getElementById('whatsappMessage').value.trim();
      
      if (phone) {
        const formattedPhone = phone.replace(/\D/g, '');
        let previewText = `https://wa.me/${formattedPhone}`;
        if (message) {
          previewText += `?text=${encodeURIComponent(message)}`;
        }
        document.getElementById('link').value = previewText;
      }
    }

    function handleLogoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 5 * 1024 * 1024) {
        showNotification('Ukuran file terlalu besar! Maksimal 5MB.', 'error');
        return;
      }

      if (!file.type.match('image.*')) {
        showNotification('Silakan upload file gambar (JPG, PNG, GIF)', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        currentLogo = e.target.result;
        showLogoPreview();
        showNotification('Logo berhasil diupload!', 'success');
      };
      reader.readAsDataURL(file);
    }

    function showLogoPreview() {
      const previewImage = document.getElementById('previewImage');
      const logoImage = document.getElementById('logoImage');
      const logoPlaceholder = document.getElementById('logoPlaceholder');
      const logoPreview = document.getElementById('logoPreview');
      const logoControls = document.getElementById('logoControls');
      const logoContainer = document.getElementById('logoContainer');

      previewImage.src = currentLogo;
      logoImage.src = currentLogo;
      logoPreview.classList.remove('hidden');
      logoControls.classList.remove('hidden');
      logoImage.classList.remove('hidden');
      logoPlaceholder.classList.add('hidden');
      logoContainer.classList.remove('hidden');

      updateLogoPosition();
    }

    function ubahUkuranLogo() {
      const sizeSlider = document.getElementById('logoSize');
      const sizeValue = document.getElementById('logoSizeValue');
      logoSize = parseInt(sizeSlider.value);
      sizeValue.textContent = logoSize;
      updateLogoPosition();
    }

    function updateLogoPosition() {
      const logoContainer = document.getElementById('logoContainer');
      if (logoContainer) {
        logoContainer.style.width = logoSize + 'px';
        logoContainer.style.height = logoSize + 'px';
      }
    }

    function hapusLogo() {
      currentLogo = null;
      document.getElementById('logoUpload').value = '';
      document.getElementById('logoPreview').classList.add('hidden');
      document.getElementById('logoControls').classList.add('hidden');
      document.getElementById('logoContainer').classList.add('hidden');
      document.getElementById('logoImage').classList.add('hidden');
      document.getElementById('logoPlaceholder').classList.remove('hidden');
      showNotification('Logo berhasil dihapus', 'info');
    }

    function ubahWarnaQR() {
      if (currentQRCode) {
        buatQR();
      }
    }

    function ubahUkuranQR() {
      const sizeSlider = document.getElementById('qrSizeSlider');
      const sizeValue = document.getElementById('qrSizeValue');
      sizeValue.textContent = sizeSlider.value;
      
      if (currentQRCode) {
        buatQR();
      }
    }

    function ubahBorder() {
      const qrcodeElement = document.getElementById('qrcode');
      const borderStyle = document.getElementById('borderStyle').value;
      const borderColor = document.getElementById('borderColor').value;
      
      if (qrcodeElement.children.length > 0) {
        if (borderStyle === 'none') {
          qrcodeElement.style.border = 'none';
        } else {
          qrcodeElement.style.border = `20px ${borderStyle} ${borderColor}`;
        }
      }
    }

    function pilihWarnaCepat(warna, bgWarna) {
      document.getElementById('qrColor').value = warna;
      document.getElementById('bgColor').value = bgWarna;
      
      document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.remove('active');
      });
      event.target.classList.add('active');
      
      if (currentQRCode) {
        buatQR();
      }
    }

    function applyTemplate(templateName) {
      switch(templateName) {
        case 'social':
          document.getElementById('qrColor').value = '#3b5998';
          document.getElementById('bgColor').value = '#ffffff';
          document.getElementById('borderColor').value = '#3b5998';
          break;
        case 'business':
          document.getElementById('qrColor').value = '#2c3e50';
          document.getElementById('bgColor').value = '#ecf0f1';
          document.getElementById('borderColor').value = '#2c3e50';
          break;
        case 'whatsapp':
          document.getElementById('qrColor').value = '#25D366';
          document.getElementById('bgColor').value = '#ffffff';
          document.getElementById('borderColor').value = '#25D366';
          document.getElementById('qrType').value = 'whatsapp';
          ubahTipeQR();
          break;
        case 'creative':
          document.getElementById('qrColor').value = '#9b59b6';
          document.getElementById('bgColor').value = '#f8f9fa';
          document.getElementById('borderColor').value = '#9b59b6';
          break;
      }
      
      if (currentQRCode) {
        buatQR();
      }
      
      showNotification(`Template ${templateName} diterapkan!`, 'success');
    }

    function downloadQR() {
      if (!currentQRCode) {
        showNotification('Buat QR Code terlebih dahulu!', 'warning');
        return;
      }

      const canvas = document.querySelector('#qrcode canvas');
      if (!canvas) {
        showNotification('QR Code belum siap untuk didownload!', 'error');
        return;
      }

      try {
        const finalCanvas = document.createElement('canvas');
        const ctx = finalCanvas.getContext('2d');
        const size = 400;
        const borderStyle = document.getElementById('borderStyle').value;
        const borderColor = document.getElementById('borderColor').value;

        finalCanvas.width = size;
        finalCanvas.height = size;

        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, size, size);

        if (borderStyle !== 'none') {
          ctx.fillStyle = borderColor;
          ctx.fillRect(0, 0, size, size);
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(15, 15, size - 30, size - 30);
        }

        ctx.drawImage(canvas, 25, 25, size - 50, size - 50);

        if (currentLogo) {
          const logoImg = new Image();
          logoImg.onload = function() {
            const logoX = size / 2 - logoSize / 2;
            const logoY = size / 2 - logoSize / 2;
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(logoX - 3, logoY - 3, logoSize + 6, logoSize + 6);
            
            ctx.drawImage(logoImg, logoX, logoY, logoSize, logoSize);
            
            doDownload(finalCanvas);
          };
          logoImg.src = currentLogo;
        } else {
          doDownload(finalCanvas);
        }
      } catch (error) {
        console.error('Error downloading QR code:', error);
        showNotification('Terjadi error saat mendownload QR code.', 'error');
      }
    }

    function doDownload(canvas) {
      const link = document.createElement('a');
      const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
      link.download = `qrcode-${timestamp}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      showNotification('QR Code berhasil didownload!', 'success');
    }

    function shareQR() {
      if (!currentQRCode) {
        showNotification('Buat QR Code terlebih dahulu!', 'warning');
        return;
      }

      const canvas = document.querySelector('#qrcode canvas');
      if (!canvas) return;

      canvas.toBlob(function(blob) {
        if (navigator.share) {
          navigator.share({
            title: 'QR Code Saya',
            text: 'Check out this QR code I created!',
            files: [new File([blob], 'qrcode.png', { type: 'image/png' })]
          }).then(() => {
            showNotification('QR Code berhasil dibagikan!', 'success');
          }).catch(error => {
            console.log('Sharing failed:', error);
            showNotification('Berbagi dibatalkan atau tidak didukung', 'info');
          });
        } else {
          showNotification('Web Share API tidak didukung di browser ini', 'warning');
        }
      });
    }

    function simpanKeHistory() {
      if (!currentQRCode) return;

      const qrType = document.getElementById('qrType').value;
      let content = '';
      
      if (qrType === 'whatsapp') {
        const phone = document.getElementById('whatsappPhone').value;
        const message = document.getElementById('whatsappMessage').value;
        content = `WhatsApp: ${phone}${message ? ` - ${message}` : ''}`;
      } else {
        content = document.getElementById('link').value;
      }
      
      const historyItem = {
        id: Date.now(),
        content: content,
        type: qrType,
        timestamp: new Date().toLocaleString(),
        colors: {
          qr: document.getElementById('qrColor').value,
          bg: document.getElementById('bgColor').value
        }
      };

      qrHistory.unshift(historyItem);
      if (qrHistory.length > 20) qrHistory.pop();
      
      localStorage.setItem('qrHistory', JSON.stringify(qrHistory));
      loadHistory();
      showNotification('QR Code disimpan ke riwayat!', 'success');
    }

    function loadHistory() {
      const historyList = document.getElementById('historyList');
      
      if (qrHistory.length === 0) {
        historyList.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #666;">
            <i class="fas fa-history" style="font-size: 3rem; margin-bottom: 10px;"></i>
            <div>Belum ada riwayat</div>
          </div>
        `;
        return;
      }

      historyList.innerHTML = qrHistory.map(item => `
        <div class="history-item" onclick="loadFromHistory('${item.id}')">
          <div class="history-info">
            <div class="history-url">${item.content}</div>
            <div class="history-date">${item.timestamp} • ${item.type}</div>
          </div>
          <i class="fas fa-chevron-right" style="color: #ccc;"></i>
        </div>
      `).join('');
    }

    function loadFromHistory(id) {
      const item = qrHistory.find(i => i.id == id);
      if (!item) return;

      if (item.type === 'whatsapp') {
        document.getElementById('qrType').value = 'whatsapp';
        ubahTipeQR();
        
        const match = item.content.match(/WhatsApp: ([^-]+)( - (.+))?/);
        if (match) {
          document.getElementById('whatsappPhone').value = match[1].trim();
          if (match[3]) {
            document.getElementById('whatsappMessage').value = match[3].trim();
          }
        }
      } else {
        document.getElementById('link').value = item.content;
        document.getElementById('qrType').value = item.type;
      }
      
      document.getElementById('qrColor').value = item.colors.qr;
      document.getElementById('bgColor').value = item.colors.bg;
      
      buatQR();
      bukaTab('customize');
      showNotification('Riwayat QR Code dimuat!', 'success');
    }

    function clearHistory() {
      if (confirm('Apakah Anda yakin ingin menghapus semua riwayat?')) {
        qrHistory = [];
        localStorage.setItem('qrHistory', JSON.stringify(qrHistory));
        loadHistory();
        showNotification('Riwayat berhasil dihapus!', 'success');
      }
    }

    function updateStats() {
      const canvas = document.querySelector('#qrcode canvas');
      if (canvas) {
        document.getElementById('qrSize').textContent = `${canvas.width}x${canvas.height}`;
      }
      document.getElementById('qrTypeLabel').textContent = 
        document.getElementById('qrType').options[document.getElementById('qrType').selectedIndex].text;
    }

    function bukaTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`.tab:nth-child(${['customize', 'history', 'scanner'].indexOf(tabName) + 1})`).classList.add('active');

      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName).classList.add('active');

      // Stop scanner when switching tabs
      if (tabName !== 'scanner' && scannerActive) {
        berhentiScan();
      }
    }

    function setupDragAndDrop() {
      const dropArea = document.querySelector('.file-upload');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight() {
        dropArea.style.borderColor = 'var(--primary)';
        dropArea.style.background = '#f0f2ff';
      }
      
      function unhighlight() {
        dropArea.style.borderColor = '#dee2e6';
        dropArea.style.background = '#f8f9fa';
      }
      
      dropArea.addEventListener('drop', handleDrop, false);
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        const fileUpload = document.getElementById('logoUpload');
        fileUpload.files = files;
        handleLogoUpload({ target: fileUpload });
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8'};
        color: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        max-width: 300px;
        transform: translateX(400px);
        transition: transform 0.3s ease;
      `;
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'}"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 100);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }
  </script>
</body>
</html>
