6;
      }
      
      .input-group {
        flex-direction: column;
      }
      
      .border-controls,
      .logo-edit-controls {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-qrcode"></i> QR Code Generator</h1>
      <p>Buat QR Code dengan mudah dan cepat</p>
    </div>

    <div class="app-container">
      <div class="main-content">
        <div class="section">
          <div class="input-group">
            <input type="url" id="link" placeholder="Masukkan URL, teks, atau data lainnya..." />
            <button class="btn" onclick="buatQR()"><i class="fas fa-bolt"></i> Generate QR</button>
          </div>
          
          <div class="input-group">
            <select id="qrType" onchange="ubahTipeQR()">
              <option value="url">URL Website</option>
              <option value="text">Teks Biasa</option>
              <option value="email">Email</option>
              <option value="phone">Nomor Telepon</option>
              <option value="sms">SMS</option>
              <option value="wifi">Wi-Fi</option>
              <option value="whatsapp">Kontak WA</option>
              <option value="vcard">Kontak (vCard)</option>
            </select>
          </div>

          <div id="dynamicFields"></div>
        </div>

        <div class="qr-display-section">
          <div class="qr-container">
            <div id="qrcode"></div>
            <div class="qr-logo hidden" id="logoContainer">
              <div class="logo-placeholder" id="logoPlaceholder"><i class="fas fa-image"></i></div>
              <img id="logoImage" class="logo-image hidden" src="" alt="Logo">
            </div>
          </div>
          
          <div class="stats">
            <div class="stat-item">
              <div class="stat-number" id="statSize">0x0</div>
              <div class="stat-label">Ukuran QR</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="statType">URL</div>
              <div class="stat-label">Tipe QR</div>
            </div>
          </div>

          <div style="margin-top: 20px;">
            <button class="btn btn-success" onclick="downloadQR()" id="downloadBtn" style="display: none;">
              <i class="fas fa-download"></i> Download QR Code
            </button>
            <button class="btn" onclick="shareQR()" id="shareBtn" style="display: none;">
              <i class="fas fa-share-alt"></i> Share
            </button>
            <button class="btn btn-warning" onclick="simpanKeHistory()" id="saveBtn" style="display: none;">
              <i class="fas fa-save"></i> Simpan
            </button>
          </div>
        </div>

        <div class="section">
          <h3><i class="fas fa-palette"></i> Template Cepat</h3>
          <div class="template-gallery">
            <div class="template-item" onclick="applyTemplate('social')">
              <div class="template-preview" style="background: linear-gradient(135deg, #3b5998, #8b9dc3);">
                <i class="fab fa-facebook-f" style="color: white;"></i>
              </div>
              <div>Social Media</div>
            </div>
            <div class="template-item" onclick="applyTemplate('business')">
              <div class="template-preview" style="background: linear-gradient(135deg, #2c3e50, #34495e);">
                <i class="fas fa-briefcase" style="color: white;"></i>
              </div>
              <div>Bisnis</div>
            </div>
            <div class="template-item" onclick="applyTemplate('whatsapp')">
              <div class="template-preview" style="background: linear-gradient(135deg, #25D366, #128C7E);">
                <i class="fab fa-whatsapp" style="color: white;"></i>
              </div>
              <div>WhatsApp</div>
            </div>
            <div class="template-item" onclick="applyTemplate('creative')">
              <div class="template-preview" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                <i class="fas fa-paint-brush" style="color: white;"></i>
              </div>
              <div>Kreatif</div>
            </div>
          </div>
        </div>
      </div>

      <div class="sidebar">
        <div class="tabs">
          <div class="tab active" onclick="bukaTab('customize')">Kustomisasi</div>
          <div class="tab" onclick="bukaTab('history')">Riwayat</div>
        </div>

        <div class="tab-container">
          <div id="customize" class="tab-content active">
            <div class="section">
              <h3><i class="fas fa-image"></i> Logo & Gambar</h3>
              <div class="file-upload" onclick="document.getElementById('logoUpload').click()">
                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <div>Klik untuk Upload Logo</div>
                <div style="font-size: 12px; color: #666;">PNG, JPG, GIF (Maks. 5MB)</div>
              </div>
              <input type="file" id="logoUpload" accept="image/*" class="hidden" onchange="handleLogoUpload(event)">
              
              <div class="logo-preview hidden" id="logoPreview">
                <img id="previewImage" src="" alt="Logo Preview">
                <div style="margin-top: 10px; font-size: 14px; color: #666;">Preview Logo</div>
              </div>

              <div class="logo-edit-controls hidden" id="logoControls">
                <div class="option-group">
                  <label>Ukuran Logo: <span id="logoSizeValue">60</span>px</label>
                  <input type="range" id="logoSize" min="30" max="100" value="60" oninput="ubahUkuranLogo()">
                </div>
                <div class="option-group">
                  <label>Opacity Logo: <span id="logoOpacityValue">100</span>%</label>
                  <input type="range" id="logoOpacity" min="0" max="100" value="100" oninput="ubahOpacityLogo()">
                </div>
                <div class="option-group">
                  <label>Rotasi Logo: <span id="logoRotationValue">0</span>Â°</label>
                  <input type="range" id="logoRotation" min="0" max="360" value="0" oninput="ubahRotasiLogo()">
                </div>
                <button class="btn btn-danger" onclick="hapusLogo()" style="width: 100%; grid-column: 1 / -1;">
                  <i class="fas fa-trash"></i> Hapus Logo
                </button>
              </div>
            </div>

            <div class="section">
              <h3><i class="fas fa-paint-brush"></i> Warna & Desain</h3>
              
              <div class="option-group">
                <label>Warna QR Code</label>
                <input type="color" id="qrColor" value="#000000" onchange="ubahWarnaQR()">
              </div>

              <div class="option-group">
                <label>Warna Background</label>
                <input type="color" id="bgColor" value="#ffffff" onchange="ubahWarnaQR()">
              </div>

              <div class="option-group">
                <label>Palet Warna Cepat</label>
                <div class="color-palette">
                  <div class="color-option active" style="background: #000000;" onclick="pilihWarnaCepat('#000000', '#ffffff')"></div>
                  <div class="color-option" style="background: #667eea;" onclick="pilihWarnaCepat('#667eea', '#ffffff')"></div>
                  <div class="color-option" style="background: #25D366;" onclick="pilihWarnaCepat('#25D366', '#ffffff')"></div>
                  <div class="color-option" style="background: #ff6b6b;" onclick="pilihWarnaCepat('#ff6b6b', '#ffffff')"></div>
                  <div class="color-option" style="background: #ffd93d;" onclick="pilihWarnaCepat('#ffd93d', '#000000')"></div>
                  <div class="color-option" style="background: #6c5ce7;" onclick="pilihWarnaCepat('#6c5ce7', '#ffffff')"></div>
                </div>
              </div>
            </div>

            <div class="section">
              <h3><i class="fas fa-crop-alt"></i> Ukuran & Border</h3>
              
              <div class="option-group">
                <label>Ukuran QR: <span id="qrSizeValue">250</span>px</label>
                <input type="range" id="qrSizeSlider" min="150" max="400" value="250" oninput="ubahUkuranQR()">
              </div>

              <div class="border-controls">
                <div class="option-group">
                  <label>Style Border</label>
                  <select id="borderStyle" onchange="ubahBorder()">
                    <option value="solid">Solid</option>
                    <option value="dashed">Dashed</option>
                    <option value="dotted">Dotted</option>
                    <option value="double">Double</option>
                    <option value="none">Tidak Ada</option>
                  </select>
                </div>

                <div class="option-group">
                  <label>Warna Border</label>
                  <input type="color" id="borderColor" value="#667eea" onchange="ubahBorder()">
                </div>

                <div class="option-group">
                  <label>Ketebalan Border: <span id="borderWidthValue">20</span>px</label>
                  <input type="range" id="borderWidth" min="0" max="50" value="20" oninput="ubahBorder()">
                </div>

                <div class="option-group">
                  <label>Radius Border: <span id="borderRadiusValue">20</span>px</label>
                  <input type="range" id="borderRadius" min="0" max="50" value="20" oninput="ubahBorder()">
                </div>
              </div>

              <div class="border-preview" id="borderPreview" style="background: #667eea;">
                Preview Border
              </div>
            </div>
          </div>

          <div id="history" class="tab-content">
            <div class="section">
              <h3><i class="fas fa-history"></i> Riwayat QR Code</h3>
              <div id="historyList">
                <div style="text-align: center; padding: 20px; color: #666;">
                  <i class="fas fa-history" style="font-size: 3rem; margin-bottom: 10px;"></i>
                  <div>Belum ada riwayat</div>
                </div>
              </div>
              <button class="btn btn-danger" onclick="clearHistory()" style="width: 100%; margin-top: 15px;">
                <i class="fas fa-trash"></i> Hapus Semua Riwayat
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State management
    let currentQRCode = null;
    let currentLogo = null;
    let logoSize = 60;
    let logoOpacity = 100;
    let logoRotation = 0;
    let qrHistory = JSON.parse(localStorage.getItem('qrHistory')) || [];

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      loadHistory();
      updateStats();
      setupEventListeners();
      ubahTipeQR();
      updateBorderPreview();
    });

    function setupEventListeners() {
      document.getElementById('link').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') buatQR();
      });
      setupDragAndDrop();
    }

    // QR Code Generation Functions
    function buatQR() {
      const container = document.getElementById('qrcode');
      const qrType = document.getElementById('qrType').value;
      
      let qrContent = '';
      
      if (qrType === 'whatsapp') {
        const phone = document.getElementById('whatsappPhone').value.trim();
        const message = document.getElementById('whatsappMessage').value.trim();
        
        if (!phone) {
          alert('Silakan masukkan nomor WhatsApp!');
          return;
        }
        
        const formattedPhone = phone.replace(/\D/g, '');
        qrContent = `https://wa.me/${formattedPhone}`;
        
        if (message) {
          qrContent += `?text=${encodeURIComponent(message)}`;
        }
      } else if (qrType === 'vcard') {
        const name = document.getElementById('vcardName').value.trim();
        const phone = document.getElementById('vcardPhone').value.trim();
        const email = document.getElementById('vcardEmail').value.trim();
        
        if (!name) {
          alert('Silakan masukkan nama kontak!');
          return;
        }
        
        qrContent = `BEGIN:VCARD\nVERSION:3.0\nFN:${name}`;
        if (phone) qrContent += `\nTEL:${phone}`;
        if (email) qrContent += `\nEMAIL:${email}`;
        qrContent += `\nEND:VCARD`;
      } else {
        const linkInput = document.getElementById('link');
        qrContent = linkInput.value.trim();
        
        if (!qrContent) {
          alert('Silakan masukkan konten untuk QR code!');
          return;
        }

        qrContent = formatQRContent(qrContent, qrType);
        if (!qrContent) return;
      }

      // Clear previous QR code
      container.innerHTML = '';
      if (currentQRCode) {
        currentQRCode.clear();
        currentQRCode = null;
      }

      const qrColor = document.getElementById('qrColor').value;
      const bgColor = document.getElementById('bgColor').value;
      const qrSize = parseInt(document.getElementById('qrSizeSlider').value);

      currentQRCode = new QRCode(container, {
        text: qrContent,
        width: qrSize,
        height: qrSize,
        colorDark: qrColor,
        colorLight: bgColor,
        correctLevel: QRCode.CorrectLevel.H
      });

      setTimeout(() => {
        document.getElementById('downloadBtn').style.display = 'inline-block';
        document.getElementById('shareBtn').style.display = 'inline-block';
        document.getElementById('saveBtn').style.display = 'inline-block';
        updateLogoPosition();
        updateStats();
        ubahBorder(); // Apply border styling
        alert('QR code berhasil dibuat!');
        
        if (qrType === 'whatsapp') {
          showWhatsAppPreview();
        }
      }, 300);
    }

    function formatQRContent(content, type) {
      switch(type) {
        case 'url':
          if (!content.startsWith('http')) {
            content = 'https://' + content;
          }
          return content;
        case 'email':
          return `mailto:${content}`;
        case 'phone':
          return `tel:${content}`;
        case 'sms':
          return `sms:${content}`;
        case 'wifi':
          const ssid = document.getElementById('wifiSSID').value.trim();
          const password = document.getElementById('wifiPassword').value.trim();
          const encryption = document.getElementById('wifiEncryption').value || 'WPA';
          return `WIFI:S:${ssid};T:${encryption};P:${password};;`;
        default:
          return content;
      }
    }

    function ubahTipeQR() {
      const qrType = document.getElementById('qrType').value;
      const dynamicFields = document.getElementById('dynamicFields');
      const linkInput = document.getElementById('link');
      
      let placeholder = '';
      
      switch(qrType) {
        case 'url':
          placeholder = 'Masukkan URL website...';
          dynamicFields.innerHTML = '';
          break;
        case 'text':
          placeholder = 'Masukkan teks...';
          dynamicFields.innerHTML = '';
          break;
        case 'email':
          placeholder = 'Masukkan alamat email...';
          dynamicFields.innerHTML = '';
          break;
        case 'phone':
          placeholder = 'Masukkan nomor telepon...';
          dynamicFields.innerHTML = '';
          break;
        case 'sms':
          placeholder = 'Masukkan nomor telepon...';
          dynamicFields.innerHTML = '';
          break;
        case 'wifi':
          placeholder = 'Masukkan nama WiFi...';
          dynamicFields.innerHTML = `
            <div class="input-group">
              <input type="text" id="wifiSSID" placeholder="Nama WiFi (SSID)" />
              <input type="text" id="wifiPassword" placeholder="Password WiFi" />
            </div>
            <div class="input-group">
              <select id="wifiEncryption">
                <option value="WPA">WPA/WPA2</option>
                <option value="WEP">WEP</option>
                <option value="nopass">Tidak Ada Password</option>
              </select>
            </div>
          `;
          break;
        case 'whatsapp':
          placeholder = 'Kontak WhatsApp';
          dynamicFields.innerHTML = `
            <div class="input-group">
              <input type="tel" id="whatsappPhone" placeholder="Nomor WhatsApp (contoh: 628123456789)" />
            </div>
            <div class="input-group">
              <textarea id="whatsappMessage" placeholder="Pesan default (opsional)"></textarea>
            </div>
            <div class="whatsapp-preview">
              <i class="fab fa-whatsapp"></i>
              <div>QR code akan membuka chat WhatsApp</div>
            </div>
          `;
          break;
        case 'vcard':
          placeholder = 'Kontak vCard';
          dynamicFields.innerHTML = `
            <div class="input-group">
              <input type="text" id="vcardName" placeholder="Nama Lengkap" />
            </div>
            <div class="input-group">
              <input type="tel" id="vcardPhone" placeholder="Nomor Telepon (opsional)" />
              <input type="email" id="vcardEmail" placeholder="Email (opsional)" />
            </div>
          `;
          break;
      }
      
      if (qrType !== 'whatsapp' && qrType !== 'vcard') {
        linkInput.placeholder = placeholder;
      }
    }

    function showWhatsAppPreview() {
      const phone = document.getElementById('whatsappPhone').value.trim();
      const message = document.getElementById('whatsappMessage').value.trim();
      
      if (phone) {
        const formattedPhone = phone.replace(/\D/g, '');
        let previewText = `https://wa.me/${formattedPhone}`;
        if (message) {
          previewText += `?text=${encodeURIComponent(message)}`;
        }
        document.getElementById('link').value = previewText;
      }
    }

    function bukaTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`.tab:nth-child(${['customize', 'history'].indexOf(tabName) + 1})`).classList.add('active');

      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName).classList.add('active');
    }

    function setupDragAndDrop() {
      const dropArea = document.querySelector('.file-upload');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight() {
        dropArea.style.borderColor = 'var(--primary)';
        dropArea.style.background = '#f0f2ff';
      }
      
      function unhighlight() {
        dropArea.style.borderColor = '#dee2e6';
        dropArea.style.background = '#f8f9fa';
      }
      
      dropArea.addEventListener('drop', handleDrop, false);
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        const fileUpload = document.getElementById('logoUpload');
        fileUpload.files = files;
        handleLogoUpload({ target: fileUpload });
      }
    }

    function handleLogoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 5 * 1024 * 1024) {
        alert('Ukuran file terlalu besar! Maksimal 5MB.');
        return;
      }

      if (!file.type.match('image.*')) {
        alert('Silakan upload file gambar (JPG, PNG, GIF)');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        currentLogo = e.target.result;
        showLogoPreview();
        alert('Logo berhasil diupload!');
      };
      reader.readAsDataURL(file);
    }

    function showLogoPreview() {
      const previewImage = document.getElementById('previewImage');
      const logoImage = document.getElementById('logoImage');
      const logoPlaceholder = document.getElementById('logoPlaceholder');
      const logoPreview = document.getElementById('logoPreview');
      const logoControls = document.getElementById('logoControls');
      const logoContainer = document.getElementById('logoContainer');

      previewImage.src = currentLogo;
      logoImage.src = currentLogo;
      logoPreview.classList.remove('hidden');
      logoControls.classList.remove('hidden');
      logoImage.classList.remove('hidden');
      logoPlaceholder.classList.add('hidden');
      logoContainer.classList.remove('hidden');

      updateLogoPosition();
    }

    function ubahUkuranLogo() {
      const sizeSlider = document.getElementById('logoSize');
      const sizeValue = document.getElementById('logoSizeValue');
      logoSize = parseInt(sizeSlider.value);
      sizeValue.textContent = logoSize;
      updateLogoPosition();
    }

    function ubahOpacityLogo() {
      const opacitySlider = document.getElementById('logoOpacity');
      const opacityValue = document.getElementById('logoOpacityValue');
      logoOpacity = parseInt(opacitySlider.value);
      opacityValue.textContent = logoOpacity;
      
      const logoImage = document.getElementById('logoImage');
      if (logoImage) {
        logoImage.style.opacity = logoOpacity / 100;
      }
    }

    function ubahRotasiLogo() {
      const rotationSlider = document.getElementById('logoRotation');
      const rotationValue = document.getElementById('logoRotationValue');
      logoRotation = parseInt(rotationSlider.value);
      rotationValue.textContent = logoRotation;
      
      const logoImage = document.getElementById('logoImage');
      if (logoImage) {
        logoImage.style.transform = `rotate(${logoRotation}deg)`;
      }
    }

    function updateLogoPosition() {
      const logoContainer = document.getElementById('logoContainer');
      if (logoContainer) {
        logoContainer.style.width = logoSize + 'px';
        logoContainer.style.height = logoSize + 'px';
      }
    }

    function hapusLogo() {
      currentLogo = null;
      document.getElementById('logoUpload').value = '';
      document.getElementById('logoPreview').classList.add('hidden');
      document.getElementById('logoControls').classList.add('hidden');
      document.getElementById('logoContainer').classList.add('hidden');
      document.getElementById('logoImage').classList.add('hidden');
      document.getElementById('logoPlaceholder').classList.remove('hidden');
      alert('Logo berhasil dihapus');
    }

    function ubahWarnaQR() {
      if (currentQRCode) buatQR();
    }

    function pilihWarnaCepat(qrColor, bgColor) {
      document.getElementById('qrColor').value = qrColor;
      document.getElementById('bgColor').value = bgColor;
      
      document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.remove('active');
      });
      event.target.classList.add('active');
      
      if (currentQRCode) buatQR();
    }

    function ubahUkuranQR() {
      const size = document.getElementById('qrSizeSlider').value;
      document.getElementById('qrSizeValue').textContent = size;
      if (currentQRCode) buatQR();
    }

    function ubahBorder() {
      const qrcode = document.getElementById('qrcode');
      const borderStyle = document.getElementById('borderStyle').value;
      const borderColor = document.getElementById('borderColor').value;
      const borderWidth = document.getElementById('borderWidth').value;
      const borderRadius = document.getElementById('borderRadius').value;
      
      document.getElementById('borderWidthValue').textContent = borderWidth;
      document.getElementById('borderRadiusValue').textContent = borderRadius;
      
      if (borderStyle === 'none') {
        qrcode.style.border = 'none';
      } else {
        qrcode.style.border = `${borderWidth}px ${borderStyle} ${borderColor}`;
      }
      
      qrcode.style.borderRadius = `${borderRadius}px`;
      
      updateBorderPreview();
    }

    function updateBorderPreview() {
      const borderStyle = document.getElementById('borderStyle').value;
      const borderColor = document.getElementById('borderColor').value;
      const borderWidth = document.getElementById('borderWidth').value;
      const borderRadius = document.getElementById('borderRadius').value;
      
      const preview = document.getElementById('borderPreview');
      preview.style.border = `${borderWidth}px ${borderStyle} ${borderColor}`;
      preview.style.borderRadius = `${borderRadius}px`;
      preview.style.backgroundColor = borderColor;
    }

    function applyTemplate(templateName) {
      const templates = {
        social: { qrColor: '#3b5998', bgColor: '#ffffff' },
        business: { qrColor: '#2c3e50', bgColor: '#ecf0f1' },
        whatsapp: { qrColor: '#25D366', bgColor: '#ffffff' },
        creative: { qrColor: '#9b59b6', bgColor: '#f8f9fa' }
      };
      
      const template = templates[templateName];
      document.getElementById('qrColor').value = template.qrColor;
      document.getElementById('bgColor').value = template.bgColor;
      
      document.querySelectorAll('.template-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.closest('.template-item').classList.add('active');
      
      if (currentQRCode) buatQR();
      
      alert(`Template ${templateName} diterapkan!`);
    }

    function downloadQR() {
      if (!currentQRCode) {
        alert('Buat QR code terlebih dahulu!');
        return;
      }

      const canvas = document.querySelector('#qrcode canvas');
      if (!canvas) return;

      try {
        const borderStyle = document.getElementById('borderStyle').value;
        const borderColor = document.getElementById('borderColor').value;
        const borderWidth = parseInt(document.getElementById('borderWidth').value);
        const borderRadius = parseInt(document.getElementById('borderRadius').value);
        const bgColor = document.getElementById('bgColor').value;
        const qrSize = parseInt(document.getElementById('qrSizeSlider').value);
        
        // Create final canvas with proper dimensions
        const finalCanvas = document.createElement('canvas');
        const ctx = finalCanvas.getContext('2d');
        
        // Calculate dimensions with border and padding
        const borderTotalWidth = borderStyle === 'none' ? 0 : borderWidth;
        const padding = 40; // Additional padding around QR code
        
        // Set canvas size including border and padding
        const finalSize = qrSize + (borderTotalWidth * 2) + (padding * 2);
        
        finalCanvas.width = finalSize;
        finalCanvas.height = finalSize;

        // Fill background
        ctx.fillStyle = bgColor;
        ctx.fillRect(0, 0, finalSize, finalSize);

        // Draw border if applicable
        if (borderStyle !== 'none' && borderWidth > 0) {
          ctx.fillStyle = borderColor;
          
          // Draw border based on style
          if (borderStyle === 'solid' || borderStyle === 'double') {
            // Draw outer border
            ctx.fillRect(0, 0, finalSize, finalSize);
            
            // Cut out inner area for border effect
            ctx.fillStyle = bgColor;
            ctx.fillRect(borderWidth, borderWidth, finalSize - borderWidth * 2, finalSize - borderWidth * 2);
            
            // For double border, draw another border inside
            if (borderStyle === 'double') {
              const innerBorderWidth = Math.max(2, borderWidth / 3);
              ctx.fillStyle = borderColor;
              ctx.fillRect(
                borderWidth + innerBorderWidth, 
                borderWidth + innerBorderWidth, 
                finalSize - (borderWidth + innerBorderWidth) * 2, 
                finalSize - (borderWidth + innerBorderWidth) * 2
              );
              
              ctx.fillStyle = bgColor;
              ctx.fillRect(
                borderWidth + innerBorderWidth * 2, 
                borderWidth + innerBorderWidth * 2, 
                finalSize - (borderWidth + innerBorderWidth * 2) * 2, 
                finalSize - (borderWidth + innerBorderWidth * 2) * 2
              );
            }
          } else if (borderStyle === 'dashed' || borderStyle === 'dotted') {
            // For dashed/dotted borders, draw as solid for download
            ctx.fillRect(0, 0, finalSize, finalSize);
            ctx.fillStyle = bgColor;
            ctx.fillRect(borderWidth, borderWidth, finalSize - borderWidth * 2, finalSize - borderWidth * 2);
          }
        }

        // Draw QR code
        const qrX = padding + borderTotalWidth;
        const qrY = padding + borderTotalWidth;
        ctx.drawImage(canvas, qrX, qrY, qrSize, qrSize);

        // Apply border radius
        if (borderRadius > 0) {
          // Create a rounded rectangle clipping path
          ctx.globalCompositeOperation = 'destination-in';
          ctx.beginPath();
          ctx.roundRect(0, 0, finalSize, finalSize, borderRadius);
          ctx.fill();
          ctx.globalCompositeOperation = 'source-over';
        }

        // Add logo if exists
        if (currentLogo) {
          const logoImg = new Image();
          logoImg.onload = function() {
            const logoSizeFinal = logoSize * 2;
            const logoX = finalSize / 2 - logoSizeFinal / 2;
            const logoY = finalSize / 2 - logoSizeFinal / 2;
            
            // Draw logo background (white circle)
            ctx.fillStyle = bgColor;
            ctx.beginPath();
            ctx.arc(finalSize / 2, finalSize / 2, logoSizeFinal / 2 + 5, 0, Math.PI * 2);
            ctx.fill();
            
            // Save context for rotation
            ctx.save();
            
            // Move to center of logo
            ctx.translate(finalSize / 2, finalSize / 2);
            
            // Apply rotation
            ctx.rotate(logoRotation * Math.PI / 180);
            
            // Draw logo with opacity
            ctx.globalAlpha = logoOpacity / 100;
            ctx.drawImage(logoImg, -logoSizeFinal / 2, -logoSizeFinal / 2, logoSizeFinal, logoSizeFinal);
            
            // Restore context
            ctx.restore();
            ctx.globalAlpha = 1;
            
            doDownload(finalCanvas);
          };
          logoImg.src = currentLogo;
        } else {
          doDownload(finalCanvas);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Gagal mendownload QR code');
      }
    }

    function doDownload(canvas) {
      const link = document.createElement('a');
      const timestamp = new Date().toISOString().slice(0, 10);
      
      link.download = `qrcode-${timestamp}.png`;
      link.href = canvas.toDataURL('image/png', 1.0);
      link.click();
      
      alert('QR code berhasil didownload!');
    }

    function shareQR() {
      if (!currentQRCode) {
        alert('Buat QR code terlebih dahulu!');
        return;
      }

      const canvas = document.querySelector('#qrcode canvas');
      if (!canvas) return;

      if (navigator.share) {
        canvas.toBlob(function(blob) {
          const file = new File([blob], 'qrcode.png', { type: 'image/png' });
          
          navigator.share({
            title: 'QR Code Saya',
            text: 'QR code dibuat dengan QR Code Generator',
            files: [file]
          }).then(() => {
            alert('QR code berhasil dibagikan!');
          }).catch(error => {
            if (error.name !== 'AbortError') {
              alert('Berbagi dibatalkan');
            }
          });
        });
      } else {
        alert('Share tidak didukung di browser ini');
        downloadQR();
      }
    }

    function simpanKeHistory() {
      if (!currentQRCode) return;
      
      const canvas = document.querySelector('#qrcode canvas');
      if (!canvas) return;
      
      // Create a canvas with border for history
      const historyCanvas = document.createElement('canvas');
      const ctx = historyCanvas.getContext('2d');
      const size = 200;
      const borderWidth = parseInt(document.getElementById('borderWidth').value);
      const borderColor = document.getElementById('borderColor').value;
      const borderRadius = parseInt(document.getElementById('borderRadius').value);
      const bgColor = document.getElementById('bgColor').value;

      historyCanvas.width = size;
      historyCanvas.height = size;

      // Draw background and border
      ctx.fillStyle = borderColor;
      ctx.fillRect(0, 0, size, size);
      
      ctx.fillStyle = bgColor;
      ctx.fillRect(borderWidth, borderWidth, size - borderWidth * 2, size - borderWidth * 2);
      
      // Draw QR code
      const qrSize = size - (borderWidth * 2) - 20;
      ctx.drawImage(canvas, borderWidth + 10, borderWidth + 10, qrSize, qrSize);

      const qrType = document.getElementById('qrType');
      const typeText = qrType.options[qrType.selectedIndex].text;
      
      let content = document.getElementById('link').value;
      if (qrType.value === 'whatsapp') {
        content = document.getElementById('whatsappPhone').value;
      } else if (qrType.value === 'vcard') {
        content = document.getElementById('vcardName').value;
      } else if (qrType.value === 'wifi') {
        content = document.getElementById('wifiSSID').value;
      }
      
      const historyItem = {
        id: Date.now(),
        type: typeText,
        content: content.substring(0, 100) + (content.length > 100 ? '...' : ''),
        timestamp: new Date().toLocaleString('id-ID'),
        dataURL: historyCanvas.toDataURL(),
        settings: {
          qrColor: document.getElementById('qrColor').value,
          bgColor: bgColor,
          borderColor: borderColor,
          borderWidth: borderWidth,
          borderRadius: borderRadius,
          logo: currentLogo,
          logoSize: logoSize,
          logoOpacity: logoOpacity,
          logoRotation: logoRotation
        }
      };
      
      qrHistory.unshift(historyItem);
      
      if (qrHistory.length > 20) {
        qrHistory = qrHistory.slice(0, 20);
      }
      
      localStorage.setItem('qrHistory', JSON.stringify(qrHistory));
      loadHistory();
      
      alert('QR code disimpan ke riwayat!');
    }

    function loadHistory() {
      const historyList = document.getElementById('historyList');
      
      if (qrHistory.length === 0) {
        historyList.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #666;">
            <i class="fas fa-history" style="font-size: 3rem; margin-bottom: 10px;"></i>
            <div>Belum ada riwayat</div>
          </div>
        `;
        return;
      }
      
      historyList.innerHTML = qrHistory.map(item => `
        <div class="history-item" onclick="loadFromHistory(${item.id})">
          <div class="history-qr">
            <img src="${item.dataURL}" width="40" height="40" style="border-radius: 5px;">
          </div>
          <div class="history-info">
            <div class="history-url">${item.content}</div>
            <div class="history-date">
              <i class="fas fa-tag" style="margin-right: 5px;"></i>${item.type} â¢ 
              <i class="fas fa-clock" style="margin-left: 5px; margin-right: 5px;"></i>${item.timestamp}
            </div>
          </div>
          <div style="color: #667eea; font-size: 1.2rem;">
            <i class="fas fa-redo"></i>
          </div>
        </div>
      `).join('');
    }

    function loadFromHistory(id) {
      const item = qrHistory.find(h => h.id === id);
      if (!item) return;
      
      // Apply settings from history
      document.getElementById('qrColor').value = item.settings.qrColor;
      document.getElementById('bgColor').value = item.settings.bgColor;
      document.getElementById('borderColor').value = item.settings.borderColor;
      document.getElementById('borderWidth').value = item.settings.borderWidth;
      document.getElementById('borderRadius').value = item.settings.borderRadius;
      
      // Update border controls
      document.getElementById('borderWidthValue').textContent = item.settings.borderWidth;
      document.getElementById('borderRadiusValue').textContent = item.settings.borderRadius;
      
      // Apply logo if exists
      if (item.settings.logo) {
        currentLogo = item.settings.logo;
        logoSize = item.settings.logoSize;
        logoOpacity = item.settings.logoOpacity;
        logoRotation = item.settings.logoRotation;
        
        document.getElementById('logoSize').value = logoSize;
        document.getElementById('logoSizeValue').textContent = logoSize;
        document.getElementById('logoOpacity').value = logoOpacity;
        document.getElementById('logoOpacityValue').textContent = logoOpacity;
        document.getElementById('logoRotation').value = logoRotation;
        document.getElementById('logoRotationValue').textContent = logoRotation;
        
        showLogoPreview();
      }
      
      document.getElementById('link').value = item.content;
      document.getElementById('qrType').value = item.type.toLowerCase();
      ubahTipeQR();
      buatQR();
      
      alert('QR code dimuat dari riwayat!');
      bukaTab('customize');
    }

    function clearHistory() {
      if (qrHistory.length === 0) {
        alert('Riwayat sudah kosong');
        return;
      }
      
      if (confirm('Hapus semua riwayat QR code?')) {
        qrHistory = [];
        localStorage.setItem('qrHistory', JSON.stringify(qrHistory));
        loadHistory();
        alert('Riwayat berhasil dihapus!');
      }
    }

    function updateStats() {
      const canvas = document.querySelector('#qrcode canvas');
      if (canvas) {
        document.getElementById('statSize').textContent = `${canvas.width}x${canvas.height}`;
      }
      
      const qrType = document.getElementById('qrType');
      document.getElementById('qrTypeLabel').textContent = qrType.options[qrType.selectedIndex].text;
    }
  </script>
</body>
</html>

